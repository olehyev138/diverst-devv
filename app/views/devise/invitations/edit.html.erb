<!DOCTYPE html>
<html>
<head>
  <title>Diverst</title>
  <%= stylesheet_link_tag (resource.enterprise.theme.nil? ? "application" : resource.enterprise.theme.asset_url), media: 'all', 'data-turbolinks-track' => true %>
  <%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
  <%= csrf_meta_tags %>
</head>
<body class="guest">
  <% if notice.present? %><p class="notice"><%= notice %></p><% end %>
  <% if alert.present? %><p class="alert"><%= alert %></p><% end %>

  <div class="site-wrap site-wrap--medium">
    <div class="content__header">
      <img class="logo logo--large" src="<%= logo_url %>">
    </div>

    <div class="content__main">
      <div class="card">
        <div class="card__section">

          <div class="row">
            <div class="col sm-6 md-3 lg-5">
              <%= image_tag resource.enterprise.cdo_picture.expiring_url(3600), class: "block", style: "width: 100%; background-size: cover; background-position: bottom center;" %>
            </div>
            <div class="col sm-6 md-3 lg-7">
              <h3><%= resource.enterprise.cdo_name %>, <%= resource.enterprise.cdo_title %></h3>

              <% if resource.enterprise.cdo_message.present? %>
                <p> <%= simple_format resource.enterprise.cdo_message %> </p>
              <% else %>
                <p>Hi! This is <%= resource.enterprise.cdo_name %>. We know that diverse teams produce better results, but our diversity mission is important for another reason: we want everyone to be fairly represented and have the same opportunities.  Our new diversity platform provides just that â€“ a place where you can collaborate on interesting problems and develop new insights together. Join us by selecting the ERGs that best represent your interests.</p>
              <% end %>
            </div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="card__section">
          <h2>Privacy Statement:</h2>
          <% if resource.enterprise.privacy_statement.present? %>
            <%= resource.enterprise.privacy_statement %>
          <% else %>
            Diverst uses a double factor authentication protocol and regards your data as highly confidential. Only authorized administrators can view this data.. Your data will never be shared with anyone or anything other than these select individuals.
          <% end %>
        </div>
      </div>

      <div class="card">
        <div class="card__section">
          <h2>ERG Events Calendar</h2>
          <a
            class="toggle_calendar btn btn--primary"
            onclick="toggle_calendar();"
            style="cursor: pointer; margin-bottom: 20px;"
          >Show/Hide Calendar</a>
          <div id="calendar" data-calendar-data-url="<%= onboarding_calendar_data_user_events_path(invitation_token: params[:invitation_token]) %>"></div>
        </div>
      </div>

      <div class="card">
        <div class="card__section">
          <%= simple_form_for resource, :as => resource_name, :url => invitation_path(resource_name), :html => { :method => :put } do |f| %>
            <%= devise_error_messages! %>
            <%= f.hidden_field :invitation_token %>

            <h2>Choose your ERG</h2>

            <% resource.enterprise.groups.each do |group| %>
              <div class="media-object" data-group-id="<%= group.id %>">
                <div class="flex-row">
                  <div class="flex-row__cell">
                    <%= image_tag group.logo.expiring_url(3600, :thumb) %>
                  </div>
                  <div class="flex-row__cell flex-row__cell--grow">
                    <h4><%= group.name %></h4>
                    <p><%= group.description %></p>
                  </div>
                </div>
              </div>
            <% end %>

            <%= f.input :first_name, required: true %>
            <%= f.input :last_name, required: true %>

            <% if !resource.enterprise.has_enabled_saml? %>
              <%= f.input :password, required: true %>
              <%= f.input :password_confirmation, required: true %>
            <% end %>

            <% resource.enterprise.fields.where(private: false).each do |cf| %>
              <%= render "shared/fields/display/custom_field", cf: cf, f: f, resource: resource %>
            <% end %>

            <%= f.button :submit, "Create my account", class: "btn--secondary btn--large btn--full" %>
          <% end %>
        </div>
      </div>
    </div>

    <script>
      function toggle_calendar() {
        $( "#calendar" ).slideToggle( "slow", function() {
          // Animation complete.
        });
      }

      $(document).ready(function(){
        applyFullCalendar();
        $('#calendar').hide();
      }); //endof document.ready

      $('.media-object').click(function() {
        $(this).toggleClass('media-object--selected');

        $('.group-id-field').remove();

        $('.media-object--selected').each(function() {
          var $hiddenField = $('<input type="hidden" name="user[group_ids][]" class="group-id-field"/>')
          $hiddenField.val($(this).data('group-id'));
          $('#edit_user').append($hiddenField);
        });
      });

      $('form#edit_user').on('submit', function(e) {
        var $form = $(this);

        //TODO don't trigger password validation if there are no password fields
        if( !is_valid($form) ) {
          e.preventDefault();
        }
      });

      function is_valid($form) {
        // If password field is present
        if( $form.find('input#user_password').length ) {
          //validate required fields and password
          return  validate_empty_fields($form) && validate_password($form) && validate_password_length($form);
        } else {
          //validate required fields only
          return validate_empty_fields($form);
        }
      }

      function validate_empty_fields($form) {
        var $incorrect_fields = $form.find('input.required').filter(function() { return this.value == ""; });

        if( $incorrect_fields.length > 0 ) {
          var message = 'Please provide values for the following fields:';

          $.each($incorrect_fields, function(index, field){
            var field_label_text = $(field).parent().siblings('label').text();

            message += '\n ' + field_label_text;
          }); //endof each

          alert(message);

          return false;
        }

        return true;
      }

      function validate_password($form) {
        var $password  = $form.find('input#user_password');
        var $confirmation = $form.find('input#user_password_confirmation');

        // We don't want to try password validation if passwords are disabled

        if( !($password.length && $confirmation.length )) {
          return true;
        }

        if( $password.val() == $confirmation.val() ) {
          return true;
        } else {
          var message = 'Passwords do not match!';
          alert(message);

          return false;
        }
      }

      function validate_password_length($form) {
        var $password  = $form.find('input#user_password');

        if( $password.val().length < 8) {
          var message = 'Passwords must be minimum 8 characters in length';
          alert(message);

          return false;
        }

        return true;
      }
    </script>
  </div>

</body>
</html>
