<div class="content__main">
  <% if @group.banner.present? %>
    <div class="row">
      <div class="col sm-12">
        <%= image_tag @group.banner.url, style: 'min-width: 100%;' %>
      </div>
    </div>
  <% end %>
  <% if @group.description.present? %>
    <div class="content__header mtmedium">
      <p style="flex: 1 1 0;"><%= allow_newlines @group.description %></p>
      <div class="flex-row flex-row--middle">
        <div class="flex-row__cell">
        </div>
      </div>
    </div>
  <% end %>
  <div class="row row--equal-height">
    <div class="col sm-12 md-9">
      <div class="row row--equal-height">
        <% if policy(@group).view_members? %>
        <div class="col sm-12 md-6">
          <div class="card">
            <div class="card__section">
              <h4 class="card__title"><%= inline_svg('icons/manage.svg', class: "icon card__icon") %></span>Newest Members</h4>
              <%= link_to "View all", group_group_members_path(@group), class: "card__action" %>

              <% @members.each do |member| %>
                <div class="row mb10">
                    <div class="col sm-3 md-2">
                      <%= image_tag(member.avatar.expiring_url(3600), size: "40") %>
                    </div>
                    <div class="col sm-9 md-10">
                      <%= link_to member.name_with_status, member %><br>
                      <%= time_ago_in_words(member.created_at) %> ago
                    </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        <% end %>

        <div class="col sm-12 md-6">
          <div class="card">
            <div class="card__section">

              <h4 class="card__title"><%= inline_svg('icons/calendar.svg', class: "icon card__icon") %>Upcoming Events</h4>
              <%= link_to "View all", group_events_path(@group), class: "card__action" %>

              <% if @upcoming_events.empty? %>
                <div class="mtlarge text-center">
                  You have not joined any events yet.
                </div>
              <% else %>
                <% @upcoming_events.each do |event| %>
                  <%= render "shared/flippable/event", event: event %>
                <% end %>
              <% end %>

            </div>
          </div>
        </div>

        <div class="col sm-12 md-6">
          <div class="card">
            <div class="card__section">

              <h4 class="card__title"><%= inline_svg('icons/news.svg', class: "icon card__icon") %>Latest News</h4>
              <%= link_to "View all", group_posts_path(@group), class: "card__action" unless @posts.count < 1 %>

              <% if @posts.empty? %>
                <p>No posts have been published yet.</p>
              <% else %>
                <% @posts.each do |news| %>
                  <%= render "shared/flippable/news_link", news: news %>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col col--stacked sm-12 md-3">
      <div class="card card--secondary">
        <div class="card__section">
        <%= image_tag @group.sponsor_image.url(:thumb), style: 'max-width: 100px; max-height:90px; border-radius: 80px;' %> <%= truncate(@group.sponsor_name, length: 10) %>
        <p style="font-style: italic;">(<%= @group.sponsor_title %>)</p>
        <% unless @group.sponsor_message.empty? %>
          <p style="font-style: italic; padding-top: 10px; padding-left: 10px;">"<%= truncate(@group.sponsor_message, length: 200) %>"</p>
        <% end %>  
        </div>
      </div>
      <% if @current_user.pending_group_member?(@group.id) %>
        * Please wait for group administrators to process your membership request.
        <% if !current_user.has_answered_group_survey? @group %>
          Take a survey below in order to speed up approvement process.
        <% else %>
          You can always
          <%= link_to 'edit', survey_group_questions_path(@group) %>
          your <% c_t(:member_preference).pluralize %>
        <% end %>
      <% end %>

      <% if !@group.members.include? current_user %>
        <% if @group.active? %>
          <%= simple_form_for :user, url: group_group_members_path(@group), method: :post do |f| %>
            <%= f.input :user_id, as: :hidden, input_html: { value: current_user.id } %>
            <%= f.submit "Join this #{ c_t(:erg) }", class: "btn btn--primary", style: 'margin-bottom: 20px;' %>
          <% end %>
        <% end %>
      <% else %>
        <%= link_to c_t(:member_preference).pluralize, survey_group_questions_path(@group), class: "btn btn--primary" unless current_user.has_answered_group_survey? @group %>
      <% end %>

      <div class="card card--secondary">
        <%= render('leader', leader: @group.lead_manager, position: "#{ c_t(:erg) } Leader") if @group.lead_manager %>

        <% @leaders.each do |group_leader| %>
          <%= render('leader', leader: group_leader.user, position: group_leader.position_name ) %>
        <% end %>
      </div>

      <% if current_user.enterprise.enable_rewards? %>
        <div class="card card--secondary">
            <div class="card__section">
            <h4 class="card__title"><%= inline_svg('icons/trophy.svg', class: "icon card__icon") %>Leaderboards</h4>
            <h5>Most Active this week</h5>
            <ol>
              <% @top_user_group_participants.each do |user_group| %>
                <li><%= user_group_performance_label(user_group) %></li>
              <% end %>
            </ol>
          </div>
          <div class="card__section">
            <h5>Top <%= c_t(:erg).pluralize %> this week</h5>
            <ol>
              <% @top_group_participants.each do |group| %>
                <li><%= group_performance_label(group) %></li>
              <% end %>
            </ol>
          </div>
        </div>
      <% end %>
      
      <% if @group.parent.present? %>
        <div class="card card--secondary">
          <div class="card__section">
            Parent-<%= c_t(:erg).titleize %><br>
            <%= link_to @group.parent.name, @group.parent %><br>
          </div>
        </div>
      <% end %>
      
       <% if @group.children.count > 0 %>
        <div class="card card--secondary">
          <div class="card__section">
            Sub-<%= c_t(:erg).titleize.pluralize %><br>
            <% @group.children.each do |child| %>
              <%= link_to child.name, child %><br>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @group.active_members.include? current_user %>
        <div class="card card--secondary">
          <div class="card__section">
            <%= simple_form_for @user_group, method: :post do |f| %>
              <%= f.input :notifications_frequency,
                collection: UserGroup.notifications_frequencies.keys.map{ |f| [t("user_group.#{ f }"), f] },
                label: "Frequency of notifications",
                include_blank: false,
                input_html:
                  {
                    class: 'ajax-toggle',
                    'data-url': group_user_group_path(@group, @user_group)
                  }
              %>
            <% end %>
          </div>
        </div>

        <%= link_to "Leave this #{ c_t(:erg) }", group_group_member_path(@group, current_user), method: :delete, class: 'btn btn--tertiary error' %>
      <% end %>
    </div>
  </div>
</div>
