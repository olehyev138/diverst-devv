<div class="content__header">
  <div class="flex-row flex-row--middle full-width">
    <div class="flex-row__cell">
      <div class="field__input-wrapper" style="width: 250px;">
        <span class="field__add-on field__add-on--right"><span class="icon icon--chevron-down"></span></span>
        <select class="field__input field__input--right-add-on" id="js-group-select">
          <% current_user.enterprise.groups.each do |group| %>
            <option value="<%= group.id %>"<%= " selected disabled" if group == @group %>><%= group.name %></option>
          <% end %>
        </select>
      </div>
    </div>
    <div class="flex-row__cell flex-row__cell--grow">
      <h1> / Group metrics</h1>
    </div>
    <div class="flex-row__cell">
      <%= link_to "Edit fields", edit_fields_group_path(@group), class: "btn btn--secondary" %>
    </div>
  </div>
</div>

<div class="content__main">
  <div class="card">
    <div class="card__section">
      <h3>Metrics</h3>
      <table class="table--has-border" id="updates-table">
        <thead>
          <th>Metric</th>
          <% @updates.each_with_index do |update, index| %>
            <th>
              <% if index == @updates.size - 1 %>
                Last update
              <% else %>
                <%= pluralize(@updates.size - index, 'updates') %> ago
              <% end %>
              (<%= update.created_at.to_s :reversed_slashes %>)
            </th>
          <% end %>
        </thead>
        <tbody>
          <% @group.fields.each do |field| %>
            <tr>
              <td><%= field.title %></td>
              <% @updates.each do |update| %>
                <td><%= number_with_delimiter(field.string_value(update.info[field]), :delimiter => ',') %> <%= InitiativeUpdateDecorator.decorate(update).variance_from_previous(field) %></td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="card__section">
      <div class="flex-row">
        <div class="flex-row__cell flex-row__cell--grow">
          <h3>Graphs</h3>
        </div>
        <div class="flex-row__cell">
          <div class="form--inline">
            <div class="field">
              <div class="field__input-wrapper">
                <input type="text" class="field__input datepicker js-from-picker">
              </div>
            </div>
            <label>to </label>
            <div class="field">
              <div class="field__input-wrapper">
                <input type="text" class="field__input datepicker js-to-picker">
              </div>
            </div>
          </div>
        </div>
        <div class="flex-row__cell">
          <a class="btn btn--primary btn--small js-time-range-btn" href="#">Filter</a>
        </div>
      </div>

      <% @group.fields.each do |field| %>
        <div class="graph" style="width: 49%; display: inline-block;" data-field-id="<%= field.id %>" data-field-title="<%= field.title %>"></div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Date filters datepickers

  var fromPicker = new Pikaday({
    field: $('.js-from-picker')[0],
    format: 'D MMM YYYY',
    yearRange: [new Date().getFullYear() - 2, new Date().getFullYear()]
  });

  fromPicker.setMoment(moment().startOf('year'));

  var toPicker = new Pikaday({
    field: $('.js-to-picker')[0],
    format: 'D MMM YYYY',
    yearRange: [new Date().getFullYear() - 2, new Date().getFullYear()]
  });

  toPicker.setMoment(moment().endOf('year'));


  // Field time series graphs

  var graphs = [];

  $('.graph').each(function() {
    var url = '/groups/<%= @group.id %>/fields/' + $(this).data('field-id') + '/time_series';

    graphs.push(
      new TimeSeriesGraph({
        dataUrl: url,
        element: $(this),
        title: $(this).data('field-title'),
        from: fromPicker.getDate(),
        to: toPicker.getDate()
      })
    );
  });


  // Date filter button

  $('.js-time-range-btn').click(function() {
    graphs.forEach(function(graph) {
      graph.from = fromPicker.getDate();
      graph.to = toPicker.getDate();
      graph.updateData();
    });
  });


  // Group switcher

  $('#js-group-select').change(function() {
    location = "/groups/" + $(this).find(":selected").val() + '/metrics';
  });
</script>