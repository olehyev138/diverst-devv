<div class="content__header">
  <h1><%= @poll.title %></h1>
</div>

<div class="content__main">
  <p><%= @poll.description %></p>

  <h3>Stats</h3>

  <div class="card">
    <div class="card__section">
      <div class="row">
        <div class="col sm-6 md-3 lg-2">
          <small>Invitations</small>
          <h2><%= @poll.employees.count %></h2>
        </div>
        <div class="col sm-6 md-3 lg-2">
          <small>Responses</small>
          <h2><%= @poll.responses.count %></h2>
        </div>
        <div class="col sm-6 md-3 lg-2">
          <small>Response rate</small>
          <h2><%= @poll.employees.count > 0 ? "#{(@poll.responses.count.to_f / @poll.employees.count * 100).to_i}%" : "N/A" %></h2>
        </div>
      </div>
    </div>
  </div>

  <h3>Fields</h3>

  <% @poll.fields.each do |field| %>
    <div class="card">
      <div class="card__section">
        <h4><%= field.title %></h4>
        <% if @poll.responses.any? %>
          <% if field.type == "TextField" %>
            <ul>
              <% @poll.responses.each do |response| %>
                <li><%= response.info[field] %></li>
              <% end %>
            </ul>
          <% elsif field.type == "CheckboxField" || field.type == "SelectField" %>
            <div class="field-chart" data-source="<%= answer_popularities_poll_poll_field_path(@poll, field) %>"></div>
          <% elsif field.type == "NumericField" %>
            <% @stats = field.stats_in(@poll.responses) %>
            Mean: <%= @stats[:mean] %><br>
            Min: <%= @stats[:min] %><br>
            Max: <%= @stats[:max] %><br>
            Median: <%= @stats[:median] %>
          <% end %>
        <% else %>
          <p>No response yet.</p>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @poll.responses.any? %>

    <h3>Responses</h3>

    <div class="card">
      <div class="card__section">

        <% @poll.responses.order(created_at: :desc).each do |response| %>
          <div class="block-section poll-response">
            <div class="flex-row poll-response_title">
              <div class="flex-row__cell flex-row__cell--grow">
                <h4><%= response.employee.name %> - <span class="muted">answered <%= time_ago_in_words(response.created_at) %> ago</span></h4>
              </div>
              <div class="flex-row__cell">
                <span class="icon icon--chevron-down-purple"></span>
              </div>
            </div>
            <div class="poll-response_details collapsed">
              <ul class="unstyled">
                <% @poll.fields.each do |field| %>
                  <li><small><%= field.title %></small> <span class="block highlight"><%= field.string_value response.info[field] %></span></li>
                <% end %>
              </ul>
            </div>
          </div>
        <% end %>
      </div>
    </div>

  <% end %>

</div>

<script>
  $(document).on('page:change', function() {
    $(document).off('page:change');

    // Accordeon the poll responses
    $('.poll-response').click(function() {
      $(this).find('.poll-response_details').toggleClass('collapsed');
      $(this).find('.icon').toggleClass('icon--rotate');
    });

    // Render field charts
    $('.field-chart').each(function() {
      var $chart = $(this);
      var dataUrl = $(this).data('source');

      $.get(dataUrl, function(data) {
        var pollOptions = data.map(function(entry) { return entry.answer; });
        var pollAnswerCounts = data.map(function(entry) { return entry.count; });

        $chart.highcharts({
          chart: {
            type: 'column',
            style: {
              fontFamily: 'Helvetica Neue, sans-serif'
            }
          },
          title: {
            text: ''
          },
          xAxis: {
            categories: pollOptions,
            crosshair: true
          },
          yAxis: {
            min: 0,
            title: {
              text: 'Nb of answers'
            },
            allowDecimals: false
          },
          tooltip: {
            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
            pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
              '<td style="padding:0"><b>{point.y} respondents</b></td></tr>',
            footerFormat: '</table>',
            shared: true,
            useHTML: true
          },
          plotOptions: {
            column: {
              pointPadding: 0.2,
              borderWidth: 0
            }
          },
          series: [{
            name: 'All respondents',
            data: pollAnswerCounts
          }],
          colors: ['#7B77C9']
        });
      });
    });
  });
</script>