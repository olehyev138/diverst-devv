<h1><%= @poll.title %></h1>

<p><%= @poll.description %></p>

<h2>Fields</h2>

<% @poll.fields.each do |field| %>
  <div class="card">
    <div class="card__section">
      <h3><%= field.title %></h3>
      <% if field.type == "TextField" %>
        <ul>
          <% @poll.responses.each do |response| %>
            <li><%= response.info[field] %></li>
          <% end %>
        </ul>
      <% elsif field.type == "CheckboxField" || field.type == "SelectField" %>
        <div class="field-chart" data-source="<%= answer_popularities_poll_poll_field_path(@poll, field) %>"></div>
      <% elsif field.type == "NumericField" %>
        <% @stats = field.stats_in(@poll.responses) %>
        Mean: <%= @stats[:mean] %><br>
        Min: <%= @stats[:min] %><br>
        Max: <%= @stats[:max] %><br>
        Median: <%= @stats[:median] %>
      <% end %>
    </div>
  </div>
<% end %>

<h2>Responses</h2>

<table>
  <thead>
    <th>Respondent</th>
    <% @poll.fields.each do |field| %>
      <th><%= field.title %></th>
    <% end %>
  </thead>
  <tbody>
    <% @poll.responses.each do |response| %>
      <tr>
        <td><%= response.employee.name %></td>
        <% @poll.fields.each do |field| %>
          <td><%= response.info[field] %></td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<script>
  $(document).on('page:change', function() {
    $(document).off('page:change');

    $('.field-chart').each(function() {
      var $chart = $(this);
      var dataUrl = $(this).data('source');

      $.get(dataUrl, function(data) {
        var pollOptions = data.map(function(entry) { return entry.answer; });
        var pollAnswerCounts = data.map(function(entry) { return entry.count; });

        $chart.highcharts({
          chart: {
            type: 'column'
          },
          title: {
            text: 'Number of answers per choice'
          },
          xAxis: {
            categories: pollOptions,
            crosshair: true
          },
          yAxis: {
            min: 0,
            title: {
              text: 'Nb of answers'
            },
            allowDecimals: false
          },
          tooltip: {
            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
            pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
              '<td style="padding:0"><b>{point.y} respondents</b></td></tr>',
            footerFormat: '</table>',
            shared: true,
            useHTML: true
          },
          plotOptions: {
            column: {
              pointPadding: 0.2,
              borderWidth: 0
            }
          },
          series: [{
            name: 'All respondents',
            data: pollAnswerCounts
          }]
        });
      });
    });
  });
</script>