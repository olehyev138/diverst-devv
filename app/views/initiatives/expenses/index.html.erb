<div class="content__header">
  <h1>Expenses</h1>
  <%= link_to "New Expense", new_group_initiative_expense_path(@group, @initiative), class: "btn btn--primary" if policy(InitiativeExpense).new? %>
</div>

<div class="content__main">
  <div class="card">
    <div class="card__section">
      <% if @expenses.empty? %>
        <p>There are no expenses yet. <%= link_to "Create one", new_group_initiative_expense_path(@group, @initiative) %> to track your initiative's budget.</p>
      <% else %>
        <table class="table--has-border" id="expenses-table">
          <thead>
            <th>Description</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Options</th>
          </thead>
          <tbody>
            <% @expenses.each do |expense| %>
              <tr>
                <td><%= expense.description %></td>
                <td><%= number_to_currency expense.amount %></td>
                <td><%= expense.created_at.to_s :dateonly %></td>
                <td><%= link_to "Edit", edit_group_initiative_expense_path(@group, @initiative, expense) if policy(expense).edit? %> - <%= link_to "Delete", group_initiative_expense_path(@group, @initiative, expense), method: :delete, class: "error", data: { confirm: "Are you sure?" } if policy(expense).destroy? %></td>
              </tr>
            <% end %>
            <tr style="font-weight: bold;">
              <td>Total</td>
              <td><%= number_to_currency @expenses.sum(:amount) %></td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      <% end %>
    </div>
  </div>
</div>

<div class="content__header">
  <h1>Budget pressure</h1>
</div>

<div class="card">
  <div class="card__section">
    <div class="flex-row flex-row--middle flex-row--spaced">
      <div class="flex-row__cell flex-row__cell--spaced">
        <strong>Expenses</strong><br>
        <%= number_to_currency @expenses.sum(:amount) %>
      </div>
      <div class="flex-row__cell flex-row__cell--grow flex-row__cell--spaced">
        <div class="progress-bar">
          <div class="progress-bar__fill" style="width: <%= @expenses.sum(:amount).to_f / @initiative.estimated_funding * 100 %>%;"></div>
        </div>
      </div>
      <div class="flex-row__cell flex-row__cell--spaced">
        <strong>Budget</strong><br>
        <%= number_to_currency @initiative.estimated_funding %>
      </div>
    </div>
  </div>
  <div class="card__section card__section--border">
    <div class="graph"></div>
  </div>
</div>

<script>
  var lastValue = <%= @expenses.sum(:amount) %>;
  var data = [];
  for (var i = 11; i >= 0 ; i--) {
    data[i] = Math.floor(lastValue);
    lastValue = lastValue - Math.random() * Math.random() * lastValue;
  }

  $('.graph').highcharts({
    title: {
      text: 'Total expenses over time'
    },
    xAxis: {
      categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
    },
    yAxis: {
      title: {
        text: 'Amount spent (USD)'
      },
      plotLines: [{
        color: '#980006',
        width: 1,
        value: <%= @initiative.estimated_funding %>,
        dashStyle: 'Dash',
        label: {
          text: "Budget"
        }
      }],
      max: <%= @initiative.estimated_funding > @expenses.sum(:amount) ? @initiative.estimated_funding * 1.1 : @expenses.sum(:amount) %>
    },
    tooltip: {
      valuePrefix: '$'
    },
    series: [{
      name: 'Total expenses',
      data: data,
      color: '<%= current_user.enterprise.theme.try(:primary_color) || "#7B77C9" %>'
    }],
    credits: {
      enabled: false
    }
  });
</script>