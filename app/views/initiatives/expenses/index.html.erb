<div class="content__header">
  <h1>Budget status:  <%= @initiative.budget_status %></h1>

</div>

<div class="content__header">
  <h1>Expenses</h1>

  <div class="flex-row flex-row--middle">
  <% if @initiative.finished_expenses? %>
    <div class="flex-row__cell">
      This event was closed. New expenses can not be added.
    </div>
  <% else %>
    <div class="flex-row__cell">
      <%= link_to "New Expense", new_group_initiative_expense_path(@group, @initiative), class: "btn btn--primary" if policy(InitiativeExpense).new? %>
    </div>
    <div class="flex-row__cell">
      <%= link_to "Finish Expenses", finish_expenses_group_initiative_path(@group, @initiative), method: :post, class: "btn btn--secondary" if policy(@initiative).update? %>
    </div>
  <% end %>
  </div>
</div>

<div class="content__main">
  <div class="card">
    <div class="card__section">
      <% if @expenses.empty? %>
        <p>There are no expenses yet. <%= link_to "Create one", new_group_initiative_expense_path(@group, @initiative) %> to track your event's budget.</p>
      <% else %>
        <table class="table--has-border" id="expenses-table">
          <thead>
            <th>Description</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Options</th>
          </thead>
          <tbody>
            <% @expenses.each do |expense| %>
              <tr>
                <td><%= expense.description %></td>
                <td><%= number_to_currency expense.amount %></td>
                <td><%= expense.created_at.to_s :dateonly %></td>
                <td>
                  <% if @initiative.finished_expenses? %>
                    No option possible
                  <% else %>
                    <%= link_to "Edit", edit_group_initiative_expense_path(@group, @initiative, expense) if policy(expense).edit? %> - <%= link_to "Delete", group_initiative_expense_path(@group, @initiative, expense), method: :delete, class: "error", data: { confirm: "Are you sure?" } if policy(expense).destroy? %>

                  <% end %>
                </td>
              </tr>
            <% end %>
            <tr style="font-weight: bold;">
              <td>Total</td>
              <td><%= number_to_currency @expenses.sum(:amount) %></td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      <% end %>
    </div>
  </div>
</div>

<div class="content__header">
  <h1>Budget pressure</h1>
</div>

<div class="card">
  <div class="card__section">
    <div class="flex-row flex-row--middle flex-row--spaced">
      <div class="flex-row__cell flex-row__cell--spaced">
        <strong>Expenses</strong><br>
        <%= number_to_currency @expenses.sum(:amount) %>
      </div>
      <div class="flex-row__cell flex-row__cell--grow flex-row__cell--spaced">
        <div class="progress-bar">
          <div class="progress-bar__fill" style="width: <%= @expenses.sum(:amount).to_f / @initiative.estimated_funding * 100 %>%;"></div>
        </div>
      </div>
      <div class="flex-row__cell flex-row__cell--spaced">
        <strong>Budget</strong><br>
        <%= number_to_currency @initiative.estimated_funding %>
      </div>
    </div>
  </div>
  <div class="card__section card__section--border">
    <div class="card__action">
      <%= link_to "Export CSV", time_series_group_initiative_expenses_path(format: :csv) %>
    </div>
    <div class="graph js-expenses-graph"></div>
  </div>
</div>

<script>
  var url = '/groups/<%= @group.id %>/initiatives/<%= @initiative.id %>/expenses/time_series';

  new TimeSeriesGraph({
    dataUrl: url,
    element: $('.js-expenses-graph').eq(0),
    title: 'Expenses over time'
  });
</script>
