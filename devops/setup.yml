---
- hosts: all
  gather_facts: no
  pre_tasks:
    - name: Ensure everything is installed
      raw: apt-get install python-minimal aptitude -y

- hosts: all
  roles:
    - role: update
      tags: ['update']

    - role: matic-insurance.hostname
      fqdn_hostname: '{{ inventory_hostname }}'
      tags: ['hostname']

    - role: geerlingguy.ntp
      tags: ['ntp']

- hosts: app
  pre_tasks:
    - name: Gather facts from BigBrother
      setup:
      delegate_to: "{{ item }}"
      delegate_facts: True
      with_items: "{{ groups['bigbrother'] }}"
      tags: ['metrics']
  roles:
    - role: amaabca.loggly_tls
      loggly:
        refresh_unicorn: false
        logrotate: false
        application:
          environment: 'env'
      tags: ['logger']

    - role: monit
      monit_add_user_to_group: '{{ application_user }}'
      monit_app_prefix: 'diverst-'
      monit_app_root: '{{ application_root }}/'
      monit_app_user: '{{ application_user }}'
      monit_app_run_prefix: '{{ application_run_prefix }}'
      monit_watch_puma: '{{ "webserver" in group_names }}'
      monit_watch_sidekiq: '{{ "worker" in group_names }}'
      monit_watch_clockwork: '{{ "worker" in group_names }}'
      tags: ['monit']

    - role: metrics
      metrics_influxdb_host: "http://{{ hostvars[groups['bigbrother'][0]]['ansible_default_ipv4']['address'] }}:8086"
      metrics_influxdb_database: 'telegraf'
      tags: ['metrics']

- hosts: bigbrother
  roles:
    - role: angstwad.docker_ubuntu
      docker_group_members: "{{ [docker_group_member | default(None)] | select('string') | list }}"
      tags: ['docker']

    - role: monitoring
      tags: ['monitoring']
