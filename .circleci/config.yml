version: 2.1

workflows:
  version: 2.1
  lint-test-deploy:
    jobs:
      - lint
      - backend-test:
          requires:
            - lint
      - frontend-test:
          requires:
            - lint
      - deploy:
          context: aws-context
          requires:
            - backend-test
            - frontend-test
          filters:
            branches:
              only: react_update

jobs:
  lint:
    working_directory: ~/TeamDiverst/diverst-development
    docker:
      - image: awsdiverst/cci-primary:0.0.1
        environment:
          RAILS_ENV: test
          RACK_ENV: test
    shell: /bin/bash --login
    steps:
      - checkout
      #
      ## Install gems
      #
      - restore_cache:
          keys:
            - v1-gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
            - v1-gem-cache-{{ arch }}-{{ .Branch }}-
            - v1-gem-cache-{{ arch }}-
      - run:
          name: Install gems
          command: bundle install --path=vendor/bundle --jobs=4 --retry=3 && bundle clean
      - save_cache:
          key: v1-gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - ./vendor/bundle
      #
      ## Install node modules
      #
      - restore_cache:
          keys:
            # when lock file changes, use increasingly general patterns to restore cache
            - node-{{ .Branch }}-{{ checksum "./client/package-lock.json" }}
            - node-{{ .Branch }}-
            - node-
      - run:
          name: Install node modules
          command: cd client && npm install
      - save_cache:
          paths:
            - ./client/node_modules
          key: node-{{ .Branch }}-{{ checksum "./client/package-lock.json" }}
      #
      ## Run linter
      #
      - run:
          name: Run linter
          command: |
            export PRONTO_GITHUB_ACCESS_TOKEN=60fc301a32c3a0450eeec2985a1c1a09cefba857
            export PRONTO_PULL_REQUEST_ID=$(git ls-remote -q origin pull\*\head | grep $CIRCLE_SHA1 | sed 's/.*refs\/pull\/\([0-9]*\)\/head/\1/g')
            bundle exec pronto run -f github_status github_pr -c origin/react_update
  backend-test:
    working_directory: ~/TeamDiverst/diverst-development
    parallelism: 2
    shell: /bin/bash --login
    environment:
      CIRCLE_TEST_REPORTS: /tmp/circleci-test-results/rspec
    docker:
      - image: awsdiverst/cci-primary:0.0.1
        environment:
          RAILS_ENV: test
          RACK_ENV: test
      - image: circleci/mariadb:10.4.12
    steps:
      - checkout
      - run:
          name: Create artifact directories
          command: mkdir -p $CIRCLE_TEST_REPORTS
      - run:
          name: Set timezone
          working_directory: ~/TeamDiverst/diverst-development
          command: echo ''America/New_York'' | tee -a /etc/timezone
      #
      ## Install gems
      #
      - restore_cache:
          keys:
            - v1-gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
            - v1-gem-cache-{{ arch }}-{{ .Branch }}-
            - v1-gem-cache-{{ arch }}-
      - run:
          name: Install gems
          command: bundle install --path=vendor/bundle --jobs=4 --retry=3 && bundle clean
      - save_cache:
          key: v1-gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - ./vendor/bundle
      #
      ## Setup database config
      #
      - run:
          name: Configure database
          command: |
            mkdir -p config && echo 'test:
              database: circle_test
              adapter: mysql2
              url: <%= ENV["DATABASE_URL"] %>
              pool: <%= ENV["DB_POOL"] || ENV["MAX_THREADS"] || 20 %>
              encoding: utf8mb4
              collation: utf8mb4_bin
              username: root
              host: 127.0.0.1
            ' > config/database.yml
      - run:
          name: Setup database
          command: bundle exec rake db:create db:schema:load --trace
          environment:
            RAILS_ENV: test
            RACK_ENV: test
      - run:
          name: Migrate database
          command: bundle exec rake db:migrate
      #
      ## Run backend tests
      #
      - run:
          name: Run backend tests
          command: bundle exec rspec --color --require spec_helper --format RspecJunitFormatter --out $CIRCLE_TEST_REPORTS/rspec.xml --format progress -- $(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=filesize)
          environment:
            RAILS_ENV: test
            RACK_ENV: test
      #
      ## Store artifacts
      #
      - store_test_results:
          path: /tmp/circleci-test-results/rspec
      - store_artifacts:
          path: /tmp/circleci-test-results/rspec
  frontend-test:
    working_directory: ~/TeamDiverst/diverst-development/
    docker:
      - image: awsdiverst/cci-primary:0.0.1
        environment:
          RAILS_ENV: test
          RACK_ENV: test
    shell: /bin/bash --login
    environment:
      JEST_JUNIT_OUTPUT_DIR: /tmp/circleci-test-results/junit/js-test-results.xml
    steps:
      - checkout
      - run:
          name: Create artifact directories
          command: mkdir -p /tmp/circleci-test-results/junit
      #
      ## Install node modules
      #
      - restore_cache:
          keys:
            # when lock file changes, use increasingly general patterns to restore cache
            - node-{{ .Branch }}-{{ checksum "./client/package-lock.json" }}
            - node-{{ .Branch }}-
            - node-
      - run:
          name: Install node modules
          command: cd client && npm install
      - save_cache:
          paths:
            - ./client/node_modules
          key: node-{{ .Branch }}-{{ checksum "./client/package-lock.json" }}
      #
      ## Run frontend tests
      #
      - run:
          name: Run frontend tests
          command: cd client/ && npm test -- --ci --runInBand --reporters=default --reporters=jest-junit
      #
      ## Store artifacts
      #
      - store_artifacts:
          path: /tmp/circleci-test-results/junit
      - store_test_results:
          path: /tmp/circleci-test-results/junit
  deploy:
    working_directory: ~/TeamDiverst/diverst-development/
    docker:
      - image: awsdiverst/cci-primary:0.0.1
        environment:
          RAILS_ENV: test
          RACK_ENV: test
    shell: /bin/bash --login
    environment:
    steps:
      - checkout
      - run:
          name: Authenticate with AWS
          command: echo $(./devops/scripts/cli-assume-role "$AWS_CLI_ROLE_ARN") > $BASH_ENV
      - run:
          name: Deploy backend
          command: |
            VERSION_LABEL="v${CIRCLE_SHA1:0:8}"
            ./devops/scripts/create-app-version "$AWS_TEST_ENV" "$VERSION_LABEL" "$AWS_MASTER_BUCKET"
            ./devops/scripts/deploy-app-version "$AWS_TEST_ENV" "$VERSION_LABEL"
      #
      ## Install node modules for frontend building
      #
      - restore_cache:
          keys:
            # when lock file changes, use increasingly general patterns to restore cache
            - node-{{ .Branch }}-{{ checksum "./client/package-lock.json" }}
            - node-{{ .Branch }}-
            - node-
      - run:
          name: Install node modules
          command: cd client && npm install
      - save_cache:
          paths:
            - ./client/node_modules
          key: node-{{ .Branch }}-{{ checksum "./client/package-lock.json" }}
      #
      ## Build & deploy frontend
      #
      - run:
          name: Build & deploy frontend
          command: ./devops/scripts/deploy-frontend "$AWS_FRONTEND_BUCKET"
